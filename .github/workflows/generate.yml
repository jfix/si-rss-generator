name: Generate Space Invaders RSS & Markdown

on:
  schedule:
    # Run hourly at minute 0
    - cron: '0 * * * *'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Generate RSS and Markdown
        run: bun run generate
        env:
          SITE_URL: https://jfix.github.io/si-rss-generator
      
      - name: Commit and push if changed
        run: |
          # Check if there are changes
          if git diff --quiet data/ docs/; then
            echo "No changes detected"
          else
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add data/news-cache.html docs/feed.xml docs/NEWS.md docs/index.html
            git commit -m "Update Space Invaders news - $(date -u +'%Y-%m-%d')" || true
            git push
          fi
  
  # Deploy to GitHub Pages
  deploy:
    needs: generate
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
